* Building from git repo

After downloading need to re-run the setup to download electron etc.

lein descjop-init
lein descjop-externs

The second one of these will fail when there are any events or subscriptions that have names starting with a double colon. At the moment, these are the ones:

| anh-front.core  | ::events/initialize-db  |
| anh-front.views | ::subs/name             |
|                 | ::subs/projects         |

Removing one of the colons, running lein descjop-externs and then replacing the colons works.

lein-externs has an issue and a pull request to fix this, but no response. There is a fork of lein-externs that has the fix, which I have cloned and linked in checkouts. Not yet tested
[2018-05-31 Thu] Seems to work [Tue 10 Jul 16:27:03 2018]

Removed grunt-download-electron after updating to electron 2.0.4 because npm was complaining about vulnerabilities and they were all in that or its dependancies. Can probably do without grunt altogether.

Note that electron-packager should be run inside (or specify?) the app/prod directory.
electron-packager . --icon=../../resources/anh.icns
maybe:
electron-packager app/prod --icon=resources/anh.icns --overwrite

run lein rebuild first or it will build with an old version of prod.

see https://github.com/rasom/lein-externs

* Debugging assistants
** re-frisk
NOTE Using this stops the re-frame template from running, ie lein new re-frame throws an error.

This seems to work. Added [lein-re-frisk "0.5.5"] to ~/.lein/profiles.clj in the :user :plugins section.
Added [re-frisk-remote.core] to the requires in anh-front.core, and called (enable-re-frisk-remote!) in init! as below:
#+BEGIN_SRC clojure
(ns anh-front.core
  (:require  [reagent.core :as reagent :refer [atom]]
             [re-frame.core :as re-frame]
             [anh-front.events :as events]
             [anh-front.views :as views]
             [anh-front.config :as config]
             [re-frisk-remote.core :refer [enable-re-frisk-remote!]]))

(defn mount-root [setting]
  (re-frame/clear-subscription-cache!)
  (reagent/render [views/main-panel]
                  (.getElementById js/document "app")))

(defn init! [setting]
  (re-frame/dispatch-sync [::events/initialize-db])
  (enable-re-frisk-remote!)
  (mount-root setting))
#+END_SRC
Then run the re-frisk server with lein re-frisk and the electron executable and go to localhost:4567 to see the re-frisk data. The server doesn't seem to like being run in the background which is a pain in the arse, but workable.

** js console
Nice and easy access to the re-frame database using this command:
#+BEGIN_SRC javascript
window.re_frame.db.app_db.state
#+END_SRC
** in repl
re-frame.db/app-db shows the contents of db, but also gives an error message.?!? Plus emacs doesn't like the volume of data, and the error means it can't be dereferenced and filtered to limit the amount of data returned. re-frame-demo project doesn't suffer from this. Reverting re-frame to version "0.10.4" fixed this. But only temporarily. What seems to work is changing the version, re-running lein descjop-externs and restarting the repls. Haha. That was because the repl and the browser are seeing different things. Edit a file and save it and the error goes away.
** re-frame-10x
Works fine when included from the re-frame template but not so easy to add by hand.

Using master branch from commit a52a0d1e83b278fd2129948c7334d9b8b3e33581 I get these warnings when running the cljsbuild:
#+BEGIN_SRC shell
(master) working: lein rebuild
Compiling ClojureScript...
Compiling "app/dev/js/main.js" from ["src"]...
WARNING: Use of undeclared Var devtools.formatters.core/header-api-call at line 112 app/dev/js/out_main/day8/re_frame_10x/view/components.cljs
WARNING: Use of undeclared Var devtools.formatters.core/body-api-call at line 115 app/dev/js/out_main/day8/re_frame_10x/view/components.cljs
WARNING: Use of undeclared Var devtools.formatters.core/has-body-api-call at line 118 app/dev/js/out_main/day8/re_frame_10x/view/components.cljs
WARNING: Use of undeclared Var re-frame.subs/kind at line 26 app/dev/js/out_main/day8/re_frame_10x/view/parts.cljs
WARNING: Use of undeclared Var re-frame.fx/kind at line 28 app/dev/js/out_main/day8/re_frame_10x/view/parts.cljs
WARNING: Use of undeclared Var re-frame.cofx/kind at line 30 app/dev/js/out_main/day8/re_frame_10x/view/parts.cljs
Successfully compiled "app/dev/js/main.js" in 28.472 seconds.
#+END_SRC
Get this error message when trying to start electron:
#+BEGIN_SRC shell
(master) working: ./electron/Electron.app/Contents/MacOS/Electron app/dev
App threw an error during load
ReferenceError: document is not defined
    at day8$re_frame_10x$inject_devtools_BANG_ (/Users/iain/Code/Clojure/Descjop/working/app/dev/js/out_main/day8/re_frame_10x.js:435:56)
    at Object.<anonymous> (/Users/iain/Code/Clojure/Descjop/working/app/dev/js/out_main/day8/re_frame_10x/preload.js:12:41)
    at Object.<anonymous> (/Users/iain/Code/Clojure/Descjop/working/app/dev/js/out_main/day8/re_frame_10x/preload.js:16:3)
    at Module._compile (module.js:569:30)
    at Object.Module._extensions..js (module.js:580:10)
    at Module.load (module.js:503:32)
    at tryModuleLoad (module.js:466:12)
    at Function.Module._load (module.js:458:3)
    at Module.require (module.js:513:17)
    at require (internal/module.js:11:18)

#+END_SRC
Updating to re-frame-10x 0.2.1-SNAPSHOT gets reid of the warnings but not the errors on electron startup.

* Bugs
** TODO [#C] J key for json export is interfering with keywording
** TODO [#C] ; key doesn't work when selecting keyword sets
** TODO [#D] project tree not expanding on startup (pics displayed ok tho)
** TODO [#D] Empty keyword set created when tab is hit in create text-box
** TODO [#E] Delete keyword should refresh keyword tree.
** TODO [#E] Delete keyword should delete keyword from photos too.
** TODO [#E] Selecting a keyword which is not in any photos should clear the pictures display
** TODO [#E] space should not scroll the pictures window
** TODO [#D] go to project should switch left-panel to projects
** TODO [#D] return doesn't close popover
Probably needs adding to always-listen-keys
** TODO [#D] :selected-pics can sometimes contain an empty string
this confuses JSON export. Might be easier to guard against empty entries than track down what causes them.
** TODO [#H] Production app is reading but not writing local-storage
Seems to be working for most things. Circumstances where the save is done need to be clarified and improved.
** TODO [#I] Attempts to write IPTC fields to the API even when empty.
Not seeing this anymore, and would it matter?
** TODO [#I] Edit key doesn't always work without switching panel focus.
Need to see this on the production version before worrying about it. Probably won't show unless the app is refreshed. (can't do a refresh from the prod version)
** TODO [#F] Switching back to grid view doesn't call scrollIntoview
** TODO [#F] Correct info display when pictures are selected by keyword (In the footer bar)
** TODO [#G] Add keyword in keywording/panel doesn't clear when triggered
** TODO [#G] Missing a delete key for keywords and keyword sets
** TODO [#H] Preserve order amongst keywords. New ones should be added to the end
** TODO [#I] Broke the expand of nodes to the saved project.
Only when doing a refresh and projects pane is not selected. I don't think this can happen in the production environment.

* Improvements
** Filters
*** TODO [#G] Filter by colour label.
Would be nice, but lots of work and not that important.
*** TODO [#F] Filter by tags stored in keywords
Could use this as a substitute for colour labels, even allocate a colour to each of t1 to t9
** TODO [#E] Interface with image-search for more complex searches.
Could be done by reading the contents of picture list from a file,
or by expanding the api to take clojure code to feed to image-search.
Ideally there should be an "open in hinh-anh" option in image-search.
** TODO [#D] Search tree for a project or keyword.
*** TODO [#D] Add a find project popover.
** TODO [#C] keyword set needs an update-from-current button (or save it automatically)
** TODO [#E] tree should use subs not directly access db (document it too)
** TODO [#F] Make tabs to select the different views in the left panel.
** TODO [#F] Refactor to make use of :refresh-pictures
instead of storing changes directly to db
** TODO [#F] display best for every sub keyword
**** TODO [#F] Add API call to return all best images
*** TODO [#G] Display current state of all/best
** TODO [#F] Add zoom function to single pic display.
   This will probably mean switching from displaying the pic as a background to and img tag.
** TODO [#G] Display best image even if it isn't up to the current Rating
May not be worth doing. Maybe reset filter-stars if picture-list is empty? Or alter filter to include pictures tagged with red.** TODO [#G] Make api consistent
Parameter ordering is different when adding keywords and iptc data
** TODO [#G] Remove dependancy on css to colour the selected tree item.
One possible solution is to have calls to subscriptions that are defined outside of tree.cljs. Idealy these would be conditional so that it would still work independantly of any external code.
** TODO [#G] re-write open-files. Shouldn't assume .jpg.
** TODO [#G] export and import keyword sets
** TODO [#G] add messages to simple-response
** TODO [#I] Add bulk editing of IPTC fields
** TODO [#I] Clean up the way panels are selected and keysets changed.
 There may be some redundancy in that I probably shouldn't have to change panel-focus and key-set independantly. Partially sorted. Don't need to toggle focus except when projects are in view. Still need to improve it so I CAN'T toggle focus except when projects are in view.
** TODO [#I] find out how to style the box around a button.
It's generated automatically and only seems to allow the button to expand to full width when it's contained in an otherwise spurious v-box
